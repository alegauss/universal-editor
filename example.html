<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="urn:adobe:aue:system:namespace" content="aue" />
    <title>P√°gina Edit√°vel</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
        padding: 40px;
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #3498db;
      }

      h1 {
        font-size: 36px;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      article {
        margin: 30px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      article p {
        margin-bottom: 15px;
      }

      img {
        width: 100%;
        max-width: 600px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        margin-top: 20px;
      }

      /* Estilos para modo de edi√ß√£o */
      html.aue-edit-mode [data-aue-resource] {
        outline: 2px dashed #3498db;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
      }

      html.aue-edit-mode [data-aue-resource]:hover {
        outline-color: #e67e22;
        background-color: rgba(230, 126, 34, 0.05);
      }

      html.aue-edit-mode [data-aue-resource]:hover::before {
        content: attr(data-aue-label);
        position: absolute;
        top: -25px;
        left: 0;
        background: #2c3e50;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        z-index: 1000;
      }

      /* Overlay de carregamento */
      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #7f8c8d;
      }
    </style>
    
    <script type="application/vnd.adobe.aue.models+json">
      {
        "component-models": {
          "text": {
            "fields": [
              { "name": "jcr:title", "type": "text" },
              { "name": "text", "type": "richtext" }
            ]
          }
        }
      }
    </script>
  </head>
  <body>
    <main
      data-aue-resource="jcr:content/root"
      data-aue-type="container"
      data-aue-label="Main Content"
    >
      <header>
        <h1
          data-aue-resource="jcr:content/root/title"
          data-aue-type="text"
          data-aue-prop="jcr:title"
          data-aue-label="Page Title"
        >
          üé® Bem-vindo ao Universal Editor
        </h1>
      </header>

      <article
        data-aue-resource="jcr:content/root/content"
        data-aue-type="richtext"
        data-aue-prop="text"
        data-aue-label="Article Content"
      >
        <p>
          Este √© um <strong>conte√∫do edit√°vel</strong> que pode ser modificado
          atrav√©s do Universal Editor.
        </p>
        <p>
          Para editar, clique no bot√£o <strong>"‚úèÔ∏è Editar"</strong> na barra superior
          e depois clique em qualquer elemento destacado.
        </p>
        <p>
          Voc√™ pode editar:
        </p>
        <ul>
          <li>T√≠tulos e textos simples</li>
          <li>Conte√∫do rico com formata√ß√£o</li>
          <li>Imagens e m√≠dias</li>
          <li>Componentes reutiliz√°veis</li>
        </ul>
      </article>

      <img
        data-aue-resource="jcr:content/root/image"
        data-aue-type="media"
        data-aue-prop="fileReference"
        data-aue-label="Featured Image"
        src="https://via.placeholder.com/800x400/3498db/ffffff?text=Imagem+Edit√°vel"
        alt="Imagem em destaque"
      />
    </main>

    <!-- SCRIPT CORRIGIDO -->
    <script>
      console.log('üöÄ Inicializando Universal Editor no frame filho');

      // Notifica o host que est√° pronto
      if (window.parent !== window) {
        setTimeout(() => {
          window.parent.postMessage({
            source: 'universal-editor-child',
            method: 'ready',
            args: []
          }, '*');
          console.log('‚úÖ Notifica√ß√£o de "ready" enviada ao host');
        }, 100);
      }

      // ========================================================================
      // ESCUTA MENSAGENS DO HOST
      // ========================================================================
      window.addEventListener('message', (event) => {
        // Verifica origem da mensagem
        if (event.data?.source !== 'universal-editor-host') return;

        const { method, args } = event.data;
        console.log('üì© Mensagem recebida do host:', method, args);

        // Processa os comandos
        if (method === 'enableEditMode') {
          enableEditMode();
        } else if (method === 'disableEditMode') {
          disableEditMode();
        }
      });

      // ========================================================================
      // CONTROLE DE MODO
      // ========================================================================
      function enableEditMode() {
        console.log('‚úèÔ∏è Modo de edi√ß√£o ATIVADO');
        document.documentElement.classList.add('aue-edit-mode');
        
        // Adiciona indicador visual
        const indicator = document.createElement('div');
        indicator.id = 'edit-mode-indicator';
        indicator.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          background: #27ae60;
          color: white;
          padding: 8px 12px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: bold;
          z-index: 9999;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;
        indicator.textContent = '‚úèÔ∏è MODO DE EDI√á√ÉO';
        document.body.appendChild(indicator);
      }

      function disableEditMode() {
        console.log('üëÅÔ∏è Modo de visualiza√ß√£o ATIVADO');
        document.documentElement.classList.remove('aue-edit-mode');
        
        // Remove indicador visual
        const indicator = document.getElementById('edit-mode-indicator');
        if (indicator) indicator.remove();
      }

      // ========================================================================
      // INTERATIVIDADE DOS ELEMENTOS EDIT√ÅVEIS - ATUALIZADO
      // ========================================================================
      document.addEventListener('click', (e) => {
        const editable = e.target.closest('[data-aue-resource]');
        
        // Se n√£o for elemento edit√°vel ou n√£o estiver em modo de edi√ß√£o, ignore
        if (!editable || !document.documentElement.classList.contains('aue-edit-mode')) {
          return;
        }

        e.preventDefault();
        e.stopPropagation();

        const resource = editable.getAttribute('data-aue-resource');
        const selector = `[data-aue-resource="${resource}"]`;
        const type = editable.getAttribute('data-aue-type');
        const label = editable.getAttribute('data-aue-label');

        console.log('üéØ Clicou em elemento edit√°vel:', { resource, type, label });

        // Adiciona destaque visual tempor√°rio
        editable.style.outline = '3px solid #e67e22';
        setTimeout(() => {
          editable.style.outline = '';
        }, 500);

        // Notifica o host sobre a sele√ß√£o
        window.parent.postMessage({
          source: 'universal-editor-child',
          method: 'selectElement',
          args: [selector, { type, label }]
        }, '*');

        // Abre o editor apropriado baseado no tipo
        if (type === 'richtext') {
          window.parent.postMessage({
            source: 'universal-editor-child',
            method: 'openRTE',
            args: [selector, { label }]
          }, '*');
        } else if (type === 'text') {
          editTextInline(editable);
        } else if (type === 'media') {
          // NOVO: Abre o editor de imagem
          window.parent.postMessage({
            source: 'universal-editor-child',
            method: 'openImageEditor',
            args: [selector, { label }]
          }, '*');
        }
      });

      // ========================================================================
      // EDI√á√ÉO INLINE PARA TEXTO SIMPLES
      // ========================================================================
      function editTextInline(element) {
        const originalText = element.textContent;
        const input = document.createElement('input');
        
        input.type = 'text';
        input.value = originalText;
        input.style.cssText = window.getComputedStyle(element).cssText;
        input.style.width = '100%';
        input.style.border = '2px solid #3498db';
        input.style.outline = 'none';
        input.style.background = 'white';
        input.style.padding = '5px';
        
        element.replaceWith(input);
        input.focus();
        input.select();
        
        function save() {
          const newText = input.value.trim();
          element.textContent = newText;
          input.replaceWith(element);
          
          if (newText !== originalText) {
            const resource = element.getAttribute('data-aue-resource');
            const selector = `[data-aue-resource="${resource}"]`;
            
            console.log('üíæ Salvando altera√ß√£o inline:', selector, newText);
            
            window.parent.postMessage({
              source: 'universal-editor-child',
              method: 'updateContent',
              args: [selector, newText]
            }, '*');
          }
        }
        
        input.addEventListener('blur', save);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            save();
          }
          if (e.key === 'Escape') {
            element.textContent = originalText;
            input.replaceWith(element);
          }
        });
      }

      // ========================================================================
      // ADICIONA CONTADOR DE ELEMENTOS EDIT√ÅVEIS
      // ========================================================================
      const editableCount = document.querySelectorAll('[data-aue-resource]').length;
      console.log(`üìù Encontrados ${editableCount} elementos edit√°veis`);
    </script>
  </body>
</html>