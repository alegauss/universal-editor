<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="urn:adobe:aue:system:namespace" content="aue" />
    <title>P√°gina Edit√°vel</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 60px 20px;
        text-align: center;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      article {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
      }

      article p {
        margin-bottom: 15px;
        font-size: 1.1rem;
      }

      img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 20px 0;
      }

      /* Estilos para modo de edi√ß√£o */
      html.aue-edit-mode [data-aue-resource] {
        outline: 2px dashed #3498db;
        outline-offset: 4px;
        cursor: pointer;
        position: relative;
        transition: outline 0.2s;
      }

      html.aue-edit-mode [data-aue-resource]:hover {
        outline: 2px solid #e67e22;
        outline-offset: 4px;
      }

      html.aue-edit-mode [data-aue-resource]:hover::before {
        content: attr(data-aue-label);
        position: absolute;
        top: -25px;
        left: 0;
        background: #e67e22;
        color: white;
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 3px;
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
      }

      /* Overlay de carregamento */
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
    </style>
    
    <script type="application/vnd.adobe.aue.models+json">
      {
        "component-models": {
          "text": {
            "fields": [
              { "name": "jcr:title", "type": "text" },
              { "name": "text", "type": "richtext" }
            ]
          },
          "media": {
            "fields": [
              { "name": "fileReference", "type": "media" },
              { "name": "alt", "type": "text" }
            ]
          }
        }
      }
    </script>
  </head>
  <body>
    <main
      data-aue-resource="jcr:content/root"
      data-aue-type="container"
      data-aue-label="Main Content"
    >
      <header>
        <h1
          data-aue-resource="jcr:content/root/title"
          data-aue-type="text"
          data-aue-prop="jcr:title"
          data-aue-label="Page Title"
        >
          üé® Bem-vindo ao Universal Editor
        </h1>
      </header>

      <article
        data-aue-resource="jcr:content/root/content"
        data-aue-type="richtext"
        data-aue-prop="text"
        data-aue-label="Article Content"
      >
        <p>
          Este √© um <strong>conte√∫do edit√°vel</strong> que pode ser modificado
          atrav√©s do Universal Editor.
        </p>
        <p>
          Para editar, clique no bot√£o <strong>"‚úèÔ∏è Editar"</strong> na barra superior
          e depois clique em qualquer elemento destacado.
        </p>
        <p>
          Voc√™ pode editar:
        </p>
        <ul>
          <li>T√≠tulos e textos simples</li>
          <li>Conte√∫do rico com formata√ß√£o</li>
          <li>Imagens e m√≠dias</li>
          <li>Componentes reutiliz√°veis</li>
        </ul>
      </article>

      <img
        data-aue-resource="jcr:content/root/image"
        data-aue-type="media"
        data-aue-prop="fileReference"
        data-aue-label="Featured Image"
        src="https://via.placeholder.com/800x400/3498db/ffffff?text=Imagem+Edit√°vel"
        alt="Imagem em destaque"
      />
    </main>

    <!-- Incluir o Universal Editor TypeScript -->
    <script type="module" src="/src/universal-editor.ts"></script>
    
    <!-- Sistema de comunica√ß√£o com o host -->
    <script>
      console.log('üöÄ Inicializando comunica√ß√£o com host');

      // Verifica se est√° dentro de um iframe
      const isInIframe = window.parent !== window;

      if (isInIframe) {
        // Notifica o host que est√° pronto
        setTimeout(() => {
          window.parent.postMessage({
            type: 'aue:ready'
          }, '*');
          console.log('‚úÖ Mensagem "ready" enviada ao host');
        }, 100);

        // ========================================================================
        // ESCUTA MUDAN√áAS DE MODO DO HOST
        // ========================================================================
        window.addEventListener('message', (event) => {
          if (event.source !== window.parent) return;

          const { type, data } = event.data;
          console.log('üì© Mensagem recebida do host:', { type, data });

          if (type === 'aue:mode-change') {
            const { mode, event: eventName } = data;
            
            console.log(`üîÑ Mudando para modo: ${mode}`);
            
            // Adiciona/remove classe CSS
            if (mode === 'edit') {
              document.documentElement.classList.add('aue-edit-mode');
              console.log('‚úÖ Modo de edi√ß√£o ATIVADO');
            } else {
              document.documentElement.classList.remove('aue-edit-mode');
              console.log('‚úÖ Modo de visualiza√ß√£o ATIVADO');
            }
            
            // Dispara evento customizado para o universal-editor.ts
            const customEvent = new CustomEvent(eventName, {
              detail: { mode }
            });
            window.dispatchEvent(customEvent);
            console.log(`‚úÖ Evento disparado: ${eventName}`);
          }
        });

        // ========================================================================
        // INTERCEPTA CLIQUES EM ELEMENTOS EDIT√ÅVEIS
        // ========================================================================
        document.addEventListener('click', (e) => {
          const target = e.target.closest('[data-aue-resource]');
          if (!target) return;

          // S√≥ processa se estiver em modo de edi√ß√£o
          if (!document.documentElement.classList.contains('aue-edit-mode')) {
            console.log('‚ö†Ô∏è N√£o est√° em modo de edi√ß√£o, ignorando clique');
            return;
          }

          e.preventDefault();
          e.stopPropagation();

          const resource = target.getAttribute('data-aue-resource');
          const type = target.getAttribute('data-aue-type');
          const label = target.getAttribute('data-aue-label');
          const selector = `[data-aue-resource="${resource}"]`;

          console.log('üéØ Elemento clicado:', { selector, type, label });

          // Se for texto simples, edita inline direto aqui
          if (type === 'text') {
            editTextInline(target, selector);
            return;
          }

          // Para outros tipos, notifica o host
          window.parent.postMessage({
            type: 'aue:element-clicked',
            data: {
              selector,
              type,
              label,
              content: target.innerHTML
            }
          }, '*');
        });

        // ========================================================================
        // EDI√á√ÉO INLINE PARA TEXTO SIMPLES
        // ========================================================================
        function editTextInline(element, selector) {
          const originalText = element.textContent.trim();
          const input = document.createElement('input');

          input.type = 'text';
          input.value = originalText;
          
          // Copia estilos do elemento original
          const styles = window.getComputedStyle(element);
          input.style.cssText = styles.cssText;
          input.style.width = '100%';
          input.style.border = '2px solid #3498db';
          input.style.outline = 'none';
          input.style.background = 'white';
          input.style.padding = '5px';
          input.style.boxSizing = 'border-box';

          // Substitui o elemento pelo input
          element.replaceWith(input);
          input.focus();
          input.select();

          const save = () => {
            const newText = input.value.trim();
            element.textContent = newText;
            input.replaceWith(element);

            if (newText !== originalText) {
              console.log('üíæ Salvando altera√ß√£o inline:', selector, newText);
              
              // Notifica o host sobre a mudan√ßa
              window.parent.postMessage({
                type: 'aue:content-changed',
                data: {
                  selector,
                  content: newText
                }
              }, '*');
            } else {
              console.log('‚ÑπÔ∏è Sem altera√ß√µes');
            }
          };

          const cancel = () => {
            element.textContent = originalText;
            input.replaceWith(element);
            console.log('‚ùå Edi√ß√£o cancelada');
          };

          input.addEventListener('blur', save);
          
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              save();
            }
            if (e.key === 'Escape') {
              e.preventDefault();
              cancel();
            }
          });
        }

        // ========================================================================
        // DEBUG: Mostra elementos edit√°veis encontrados
        // ========================================================================
        const editables = document.querySelectorAll('[data-aue-resource]');
        console.log(`üìù Elementos edit√°veis encontrados: ${editables.length}`);
        editables.forEach((el, index) => {
          console.log(`  ${index + 1}. ${el.getAttribute('data-aue-label')} (${el.getAttribute('data-aue-type')})`);
        });
      } else {
        console.warn('‚ö†Ô∏è N√£o est√° dentro de um iframe');
      }
    </script>
  </body>
</html>